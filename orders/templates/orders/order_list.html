{% extends "base.html" %}

{% block title %} Список замовлень бота {{ bot.name }} {% endblock %}

{% block links %}
    <a href="{% url 'bots-management:bot-list' %}"
       class="mt-3 mb-3 text-dark text-decoration-none">Боти</a>
    <span class="text-dark">/</span>
    <a href="{% url 'bots-management:bot-list' %}"
       class="mt-3 mb-3 text-dark text-decoration-none">{{ bot.name }}</a>
    <span class="text-muted">/</span>
    <a href="{% url 'bots-management:orders:order-list' bot.slug %}"
       class="mt-3 mb-3 text-dark text-decoration-none">Замовлення</a>
{% endblock %}

{% block content %}

    <h3> Список категорій товарів бота
        {{ bot.name }}
    </h3>
    <table class="table mt-3 table-striped">
        <thead class="thead-dark">
        <tr>
            <th scope="col">#</th>
            <th scope="col">Користувач</th>
            <th scope="col">Статус</th>
            <th scope="col">Сума</th>
            <th scope="col">Дата замовлення</th>
            <th scope="col">Коментар покупця</th>
            <th scope="col">Ваш коментар</th>
            <th scope="col">Дії</th>
        </tr>
        </thead>
        <tbody>
        {% for order in orders %}

            <tr>
                <th scope="row">{{ forloop.counter }}</th>
                <td>
                    {% if order.basket.subscriber.username %}
                        <a href="https://t.me/{{ order.basket.subscriber.username }}">
                            {{ order.basket.subscriber.name }}
                        </a>
                    {% else %}
                        <span data-toggle="tooltip" data-placement="top"
                              title="У цього користувача зачинений профіль у Telegram.">
                            {{ order.basket.subscriber.name }}
                        </span>
                    {% endif %}
                </td>
                <td>{{ order.get_status_display }}</td>
                <td>{{ order.price }} {{ bot.currency.symbol }}</td>
                <td>{{ order.created_stamp|date:'H:i d/m/Y' }}</td>
                <td>
                    {% if order.customerComment %}
                        {{ order.customerComment }}
                    {% else %}
                        -
                    {% endif %}
                </td>
                <td>
                    {% if order.shopComment %}
                        {{ order.shopComment }}
                    {% else %}
                        -
                    {% endif %}
                </td>
                <td>
                    <button type="button" class="btn btn-warning" data-toggle="modal"
                            data-target="#orderModel{{ order.id }}"
                    ><i
                            class="fa fa-info-circle"></i></button>
                    {% if order.editable %}
                        <button type="button" class="btn btn-success" data-toggle="modal"
                                data-target="#orderResolveModel"
                                data-action-type="accept" data-order-id="{{ order.id }}"
                                data-customer="{{ order.basket.subscriber.name }}">Прийняти
                        </button>
                        <button type="button" class="btn btn-danger" data-toggle="modal"
                                data-target="#orderResolveModel"
                                data-action-type="decline" data-order-id="{{ order.id }}"
                                data-customer="{{ order.basket.subscriber.name }}">Відмовити
                        </button>
                    {% endif %}
                </td>
            </tr>
        {% endfor %}
        </tbody>
    </table>
{% endblock %}

{% block modal %}
    <div class="modal fade" id="orderResolveModel" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel"
         aria-hidden="true" data-bot-slug="{{ bot.slug }}">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="exampleModalLabel"></h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <form method="POST">
                        {% csrf_token %}
                        <div class="form-group">
                            <label for="message-text" class="col-form-label">Коментар:</label>
                            <textarea name="comment" class="form-control" id="message-text"></textarea>
                        </div>
                        <div class="modal-footer">
                            <input type="submit" class="btn btn-primary" value="Підтвердити">
                            <button type="button" class="btn btn-secondary" data-dismiss="modal">Назад</button>
                        </div>
                    </form>
                </div>

            </div>
        </div>
    </div>
    {% for order in orders %}
        <div class="modal fade" id="orderModel{{ order.id }}" tabindex="-1" role="dialog"
             aria-labelledby="exampleModalLabel"
             aria-hidden="true">
            <div class="modal-dialog" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="exampleModalLabel">Замовлення #{{ order.id }}</h5>
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                    <div class="modal-body">
                        <p>Користувач: <span class="">
                         {% if order.basket.subscriber.username %}
                             <a href="https://t.me/{{ order.basket.subscriber.username }}">
                            {{ order.basket.subscriber.name }}
                        </a>
                         {% else %}
                             <span data-toggle="tooltip" data-placement="top"
                                   title="У цього користувача зачинений профіль у Telegram.">
                            {{ order.basket.subscriber.name }}
                        </span>
                         {% endif %}
                        </span></p>
                        <p>Статус замовлення: <span class="">{{ order.get_status_display }}</span></p>
                        <p>Країна доставки: <span class="">{{ order.country }}</span></p>
                        <p>Користувач: <span class="">{{ order.delivery_type }}</span></p>
                        <p>Тип доставки: <span class="">{{ order.delivery_type }}</span></p>
                        <p>Спосіб оплати: <span class="">{{ order.payment_type }}</span></p>
                        <p>Сума до сплати: <span class="">{{ order.price }} {{ bot.currency.symbol }}</span></p>
                        <p>Дата створення: <span class="">{{ order.created_stamp|date:'H:i d/m/Y' }}</span></p>
                        <p>Коментар покупця: <span class="">{% if order.customerComment %}
                            {{ order.customerComment }} {% else %} - {% endif %}</span></p>
                        <p>Коментар продваця: <span class="">{% if order.shopComment %}
                            {{ order.shopComment }} {% else %}
                            - {% endif %}</span></p>
                        <div>Товари: <span class="">                    </span>

                            <ul>
                                {% for product in order.basket.products.all %}
                                    <li><a href="{{ product.get_absolute_url }}">{{ product.name }}</a></li>
                                {% endfor %}
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    {% endfor %}
{% endblock %}

{% block scripts %}
    <script>
        $('#orderResolveModel').on('show.bs.modal', function (event) {
            var button = $(event.relatedTarget)
            var orderID = button.data('order-id')
            var customerName = button.data('customer')
            var actionType = button.data('action-type')
            var modal = $(this)
            if (actionType === 'accept') {
                modal.find('.modal-title').text('Підтвердити замовлення для ' + customerName)
                document.querySelector('form').setAttribute('action', `${orderID}/accept/`)
            } else if (actionType === 'decline') {
                modal.find('.modal-title').text('Відмінити замовлення для ' + customerName)
                document.querySelector('form').setAttribute('action', `${orderID}/decline/`)
            }
        })

    </script>

{% endblock %}